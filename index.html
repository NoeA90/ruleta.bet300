<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BET300 ¬∑ Ruleta</title>
<meta name="theme-color" content="#0b0f1e"/>

<!-- Fuente -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700;800&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#0b0f1e; --panel:#121634; --panel2:#0f1330; --border:#1e2150;
  --text:#e8ebff; --muted:#b7b9d6; --pointer:#22d3ee;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  color:var(--text);
  background:var(--bg);
  font:16px/1.35 "Montserrat",system-ui,-apple-system,Segoe UI,Roboto;
}
body::before{
  content:"";
  position:fixed;inset:0;z-index:-2;
  background:
    radial-gradient(900px 500px at 50% -10%, rgba(101,74,255,.25), transparent),
    radial-gradient(700px 350px at 100% 0%, rgba(0,209,255,.18), transparent),
    linear-gradient(180deg,#0b0f1e 0%,#0b0f1e 60%,#0a0d20 100%);
}

/* Layout */
.container{max-width:980px;margin:14px auto;padding:0 14px 92px}
.card{
  background:
    radial-gradient(120% 100% at 50% 0%, rgba(124,77,255,.08), transparent),
    var(--panel2);
  border:1px solid var(--border);
  border-radius:18px;
  padding:18px;
  box-shadow:0 15px 40px rgba(0,0,0,.35);
}
@media(max-width:520px){
  .container{padding:0 0 92px}
  .card{border-radius:0;border-left:0;border-right:0;padding:14px}
}

/* Header */
.head{
  display:flex;align-items:center;gap:10px;
  margin-bottom:8px;flex-wrap:wrap;
}
.brand{
  height:30px;width:auto;
  filter:drop-shadow(0 2px 8px rgba(0,0,0,.4));
}
.pill{
  background:linear-gradient(90deg,rgba(124,77,255,.15),rgba(0,209,255,.15));
  border:1px solid var(--border);
  border-radius:999px;
  padding:6px 10px;
  font-size:12px;color:var(--muted);
}
.pill.time{display:flex;gap:8px;align-items:center}
.pill.sound{cursor:pointer;user-select:none}
.count{
  display:inline-flex;gap:6px;align-items:center;
  padding:4px 8px;border-radius:999px;
  background:rgba(255,204,0,.15);
  border:1px solid rgba(255,204,0,.35);
  color:#ffe27a;font-weight:700;font-variant-numeric:tabular-nums;
}

/* Grid */
.grid{display:grid;gap:16px;grid-template-columns:minmax(0,1fr)}
@media(min-width:900px){.grid{grid-template-columns:1.15fr .85fr}}

/* Ruleta */
.stage{position:relative;display:flex;align-items:center;justify-content:center}
.wrap{width:100%;max-width:520px;margin:auto;position:relative}
canvas{width:100%;height:auto;display:block}

/* Pointer */
.pointer{
  position:absolute;top:6px;left:50%;
  transform:translateX(-50%);
  border-left:16px solid transparent;
  border-right:16px solid transparent;
  border-bottom:26px solid var(--pointer);
  z-index:2;
  filter:
    drop-shadow(0 0 10px rgba(34,211,238,.9))
    drop-shadow(0 4px 10px rgba(0,0,0,.6));
  border-radius:4px;
}
@media(max-width:420px){
  .pointer{
    border-left:12px solid transparent;
    border-right:12px solid transparent;
    border-bottom:22px solid var(--pointer);
    top:4px;
  }
}

/* Panel derecho */
.panel{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:16px;
  padding:16px;
}
.center{text-align:center}
h1,h2,h3,p{margin:0 0 8px}
h1{font-size:24px}
.muted{color:var(--muted)}
.stat{
  display:flex;gap:12px;align-items:center;justify-content:center;
  margin:8px 0 14px;
}
.badge{
  min-width:72px;height:46px;border-radius:12px;
  background:radial-gradient(100% 100% at 50% 0%, rgba(0,209,255,.35), rgba(124,77,255,.35));
  display:grid;place-items:center;
  font-weight:800;font-size:18px;
  box-shadow:inset 0 0 10px rgba(124,77,255,.35);
}
.smallline{font-size:12px;color:var(--muted);margin-top:4px}

/* Bloque plataforma */
.promo{
  display:grid;grid-template-columns:1fr minmax(200px,260px);
  align-items:center;gap:12px;margin-top:10px;
  padding:12px;border:1px dashed var(--border);border-radius:12px;
}
.promo.expired{border-color:rgba(255,107,107,.5)}
.promo .copy{display:grid;gap:4px}
.promo .eyebrow{
  padding:2px 8px;border-radius:999px;
  border:1px solid rgba(255,204,0,.35);
  background:rgba(255,204,0,.12);
  color:#ffe27a;font-weight:700;font-size:12px;width:max-content;
}
.btn.play{
  display:inline-flex;gap:10px;align-items:center;justify-content:center;
  padding:14px 16px;border-radius:12px;font-weight:800;
  background:linear-gradient(90deg,#ffd166,#ff7ab6);
  color:#0a0f20;box-shadow:0 8px 20px rgba(0,0,0,.25);
}
@media(max-width:520px){
  .promo{grid-template-columns:1fr}
  .btn.play{width:100%}
}

/* Dock inferior */
.dock{
  position:fixed;left:0;right:0;bottom:0;z-index:10;
  background:linear-gradient(180deg, rgba(11,15,30,0) 0%, rgba(11,15,30,.85) 22%, rgba(11,15,30,.95) 100%);
  padding:10px 16px 14px;display:flex;gap:12px;align-items:center;
}
.btn{
  appearance:none;border:none;cursor:pointer;
  padding:14px 16px;border-radius:14px;font-weight:800;
  background:linear-gradient(90deg,#6c59ff,#00d1ff);
  color:#0a0f20;width:100%;
  box-shadow:0 8px 20px rgba(0,0,0,.35);
}
.btn:disabled{opacity:.55;cursor:not-allowed}

/* Bot√≥n RECLAMAR ‚Äì celeste ne√≥n */
.btn.ok{
  background:linear-gradient(90deg,#5ff7ff,#2dd4ff);
  color:#020617;
}
.btn.ok:disabled{
  background:linear-gradient(90deg,#9beafe,#6ed0ff);
}

/* Bot√≥n GIRAR ‚Äì dorado */
#spinBtn{
  background:linear-gradient(90deg,#FFD166,#FFB347);
  color:#3b2100;
}
#spinBtn:disabled{
  background:linear-gradient(90deg,#FFE6A8,#FFD6A0);
}

/* Confetti */
.confetti{position:fixed;inset:0;pointer-events:none;z-index:40}
.confetti i{
  position:absolute;top:-20px;width:10px;height:14px;border-radius:2px;opacity:0;
  animation:confFall 1.6s linear forwards;
}
@keyframes confFall{
  8%{opacity:1}
  100%{transform:translateY(110vh) rotate(360deg);opacity:0}
}
</style>
</head>
<body>

<div id="confetti" class="confetti" aria-hidden="true"></div>

<div class="container">
  <div class="card">
    <div class="head">
      <img class="brand" src="logo-bet300.svg" alt="BET300">
      <span class="pill time">‚ö° Tiempo limitado <span class="count" id="countdown">--:--</span></span>
      <span class="pill sound" id="soundToggle">üîä Sonido: <b id="soundState">ON</b></span>
    </div>

    <div class="grid">
      <div class="panel">
        <div class="stage">
          <div class="wrap">
            <canvas id="wheel" width="620" height="620"></canvas>
            <div class="pointer" aria-hidden="true"></div>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="center">
          <div class="stat">
            <div>
              <div class="badge" id="badge">-</div>
              <div class="smallline" id="stampLine" aria-live="polite"></div>
            </div>
            <div>
              <h1 id="title">Ten√©s 1 giro disponible</h1>
              <p class="muted" id="subtitle">Los premios se acreditan con tu <b>pr√≥xima carga m√≠nima</b>.</p>
            </div>
          </div>
        </div>

        <div class="promo" id="promoBox">
          <div class="copy">
            <span class="eyebrow">Acceso especial</span>
            <strong>Tiempo limitado.</strong>
            <span class="muted">Entr√° y particip√° antes de que termine.</span>
          </div>
          <a id="playNow" class="btn play" target="_blank" rel="noopener">
            <span class="icon">üéÆ</span>
            <span class="label">Entrar a la plataforma</span>
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="dock">
  <button id="spinBtn" class="btn">üéØ Girar</button>
  <button id="claimBtn" class="btn ok" disabled>üì≤ Reclamar</button>
</div>

<script>
/* ========= CONFIG PREMIOS ========= */
/* ===== Premios (intercalados) ===== */
const PRIZES = [
  { type: 'money',   value: 2000 },   // $2.000
  { type: 'percent', value: 10 },     // 10%
  { type: 'money',   value: 3000 },   // $3.000
  { type: 'retry'  },                 // OTRA CHANCE
  { type: 'money',   value: 5000 },   // $5.000
  { type: 'percent', value: 20 },     // 20%
  { type: 'double' },                 // DOBLE CARGA
  { type: 'percent', value: 30 },     // 30%
];


const COLORS = [
  "#44e0ff","#7a5bff","#16e2b6","#ff6ad5",
  "#ffd166","#4be1a0","#8ab6ff","#ff9bd1"
];

/* ========= WHATSAPP / PLATAFORMA ========= */
const WP_NUMBERS = {
  principal: "54911",
  pc1: "5491171559478",
  pc2: "5491151622581",
  pc3: "5491154040255",
  pc4: "5491150030414"
};
const PLATFORM_LINKS = {
  principal: "https://plataforma.example/inicio",
  pc1: "https://300vip-c01.vercel.app/",
  pc2: "https://300vip-c02.vercel.app/",
  pc3: "https://300vip-c03.vercel.app/",
  pc4: "https://bet300.site"
};
const params = new URLSearchParams(location.search);
const pc = params.get("pc");
let WP = WP_NUMBERS.principal;
let PLATFORM = PLATFORM_LINKS.principal;
if(pc === "1"){ WP = WP_NUMBERS.pc1; PLATFORM = PLATFORM_LINKS.pc1; }
else if(pc === "2"){ WP = WP_NUMBERS.pc2; PLATFORM = PLATFORM_LINKS.pc2; }
else if(pc === "3"){ WP = WP_NUMBERS.pc3; PLATFORM = PLATFORM_LINKS.pc3; }
else if(pc === "4"){ WP = WP_NUMBERS.pc4; PLATFORM = PLATFORM_LINKS.pc4; }
document.getElementById("playNow").href = PLATFORM;

/* ========= ANTIFRAUDE ========= */
const SALT = "bet300-ruleta-v1";
function ensureDeviceId(){
  let id = localStorage.getItem("device_id");
  if(!id){
    id = (crypto.randomUUID?.() || Date.now()+"-"+Math.random().toString(36).slice(2,8));
    localStorage.setItem("device_id", id);
  }
  return id;
}
const DEVICE_ID = ensureDeviceId();
function todayKey(){
  const n=new Date();
  return n.getFullYear()+"-"+String(n.getMonth()+1).padStart(2,"0")+"-"+String(n.getDate()).padStart(2,"0");
}
function tsString(d=new Date()){
  const dd=String(d.getDate()).padStart(2,"0");
  const mm=String(d.getMonth()+1).padStart(2,"0");
  const yyyy=d.getFullYear();
  const hh=String(d.getHours()).padStart(2,"0");
  const mi=String(d.getMinutes()).padStart(2,"0");
  return dd+"/"+mm+"/"+yyyy+" "+hh+":"+mi;
}
async function sha256hex(msg){
  const enc = new TextEncoder().encode(msg);
  const buf = await crypto.subtle.digest("SHA-256", enc);
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
}
async function makeClaimCode(label){
  const base = DEVICE_ID+"|"+todayKey()+"|"+label+"|pc:"+(pc||"0")+"|"+SALT;
  const hex = await sha256hex(base);
  return hex.slice(0,10).toUpperCase();
}

/* ========= TEXTO PREMIOS ========= */
const money = n => "$"+n.toLocaleString("es-AR");

function labelPrize(p){
  if(p.type === "money")   return money(p.value);
  if(p.type === "percent") return p.value+"%";
  if(p.type === "retry")   return "OTRA CHANCE";
  if(p.type === "double")  return "DOBLE CARGA";
  return "";
}
function prizeLines(p){
  if(p.type === "retry")  return ["OTRA","CHANCE"];
  if(p.type === "double") return ["DOBLE","CARGA"];
  return [labelPrize(p)];
}
function subtitleHTML(p){
  if(p.type === "money")
    return `Ganaste <b>${money(p.value)}</b> extra para tu pr√≥xima carga m√≠nima.`;
  if(p.type === "percent")
    return `Ganaste un <b>${p.value}% extra</b> sobre el monto de tu pr√≥xima carga.`;
  if(p.type === "double")
    return `Ganaste <b>doble de tu pr√≥xima carga</b> (hasta el l√≠mite acordado con el operador).`;
  if(p.type === "retry")
    return `Te toc√≥ <b>otra chance</b>, gir√° de nuevo ahora mismo.`;
  return "";
}
function whatsappText(prizeLabel){
  const code = localStorage.getItem("spin_code") || "(SIN-COD)";
  const ts   = localStorage.getItem("spin_ts")   || tsString();
  return `Hola, gan√© ${prizeLabel} en la ruleta y quiero reclamarlo con mi pr√≥xima carga. C√≥digo: ${code} ¬∑ ${ts}`;
}

/* ========= AUDIO ========= */
let soundOn = true;
const soundToggle = document.getElementById("soundToggle");
const soundState  = document.getElementById("soundState");
const AudioKit = (()=>{
  const Ctx = window.AudioContext || window.webkitAudioContext;
  const ctx = new Ctx();
  let unlocked = false;
  function unlock(){
    if(!unlocked){
      ctx.resume().catch(()=>{});
      unlocked = true;
    }
  }
  function click(freq=900,dur=0.04,vol=0.05){
    const o=ctx.createOscillator();
    const g=ctx.createGain();
    o.type="square";
    o.frequency.value=freq;
    g.gain.value=0;
    o.connect(g).connect(ctx.destination);
    const t=ctx.currentTime;
    g.gain.linearRampToValueAtTime(vol, t+0.005);
    g.gain.exponentialRampToValueAtTime(0.0001, t+dur);
    o.start(t); o.stop(t+dur);
  }
  function spinStart(){
    const id=setInterval(()=>click(860+Math.random()*120,0.035,0.045),110);
    return ()=>clearInterval(id);
  }
  function win(){
    [880,1175,1568].forEach((f,i)=>setTimeout(()=>click(f,0.12,0.09), i*130));
  }
  return {unlock,spinStart,win};
})();
soundToggle.addEventListener("click",()=>{
  soundOn=!soundOn;
  soundState.textContent = soundOn ? "ON" : "OFF";
});

/* ========= DOM Y CANVAS ========= */
const wheel = document.getElementById("wheel");
const ctx    = wheel.getContext("2d");
const spinBtn  = document.getElementById("spinBtn");
const claimBtn = document.getElementById("claimBtn");
const badge    = document.getElementById("badge");
const titleEl  = document.getElementById("title");
const subtitleEl = document.getElementById("subtitle");
const countdownEl = document.getElementById("countdown");
const promoBox   = document.getElementById("promoBox");
const confetti   = document.getElementById("confetti");
const stampEl    = document.getElementById("stampLine");

let angle = 0;
let spinning = false;
let cx=0, cy=0, r=0, cssW=0;

function getWrapWidth(){
  const el = document.querySelector(".wrap");
  return Math.floor(el.getBoundingClientRect().width);
}
function setSize(){
  const dpr = window.devicePixelRatio || 1;
  const w = Math.min(520, Math.max(280, getWrapWidth()));
  cssW = w;
  wheel.width  = Math.floor(w*dpr);
  wheel.height = Math.floor(w*dpr);
  wheel.style.width  = w+"px";
  wheel.style.height = w+"px";
  ctx.setTransform(dpr,0,0,dpr,0,0);
  cx = wheel.width/dpr/2;
  cy = wheel.height/dpr/2;
  r  = Math.min(cx,cy) - 10;
}
window.addEventListener("resize", ()=>{
  clearTimeout(window.__wTo);
  window.__wTo = setTimeout(setSize, 120);
});

/* ========= DIBUJO RULETA ========= */
function drawWheel(){
  ctx.clearRect(0,0,wheel.width,wheel.height);
  const n   = PRIZES.length;
  const arc = Math.PI*2/n;

  const fontSize =
    cssW <= 320 ? 12 :
    cssW <= 380 ? 13 :
    cssW <= 440 ? 14 : 15;
  ctx.font = `800 ${fontSize}px Montserrat,system-ui,-apple-system,Segoe UI`;
  ctx.textAlign   = "center";
  ctx.textBaseline= "middle";

  for(let i=0;i<n;i++){
    const start = angle + i*arc;
    const end   = start + arc;
    const mid   = start + arc/2;

    let fillColor = COLORS[i % COLORS.length];
    if(PRIZES[i].type === "double") fillColor = "#FACC15";
    if(PRIZES[i].type === "retry")  fillColor = "#22d3ee";

    // sector
    ctx.beginPath();
    ctx.moveTo(cx,cy);
    ctx.arc(cx,cy,r,start,end);
    ctx.closePath();
    ctx.fillStyle = fillColor;
    ctx.fill();
    ctx.strokeStyle = "rgba(10,15,35,.35)";
    ctx.lineWidth = 2;
    ctx.stroke();

    // texto horizontal
    const lines = prizeLines(PRIZES[i]);
    const textRadius = r * 0.68;
    const baseX = cx + Math.cos(mid)*textRadius;
    const baseY = cy + Math.sin(mid)*textRadius;
    const lineHeight  = fontSize + 2;
    const totalHeight = lineHeight*(lines.length-1);

    ctx.fillStyle = "#091024";
    lines.forEach((line,idx)=>{
      const y = baseY - totalHeight/2 + idx*lineHeight;
      ctx.fillText(line, baseX, y);
    });
  }

  // aro exterior
  ctx.beginPath();
  ctx.lineWidth = Math.max(8,r*0.04);
  ctx.strokeStyle = "#424864";
  ctx.arc(cx,cy,r*1.02,0,Math.PI*2);
  ctx.stroke();

  // luces
  const bulbs = 54;
  const rr    = r*1.02;
  const t     = Date.now()/130;
  for(let i=0;i<bulbs;i++){
    const ang = i/bulbs*Math.PI*2;
    const x = cx + Math.cos(ang)*rr;
    const y = cy + Math.sin(ang)*rr;
    const on = (Math.floor(t)%bulbs) === i;
    ctx.beginPath();
    ctx.fillStyle = on ? "rgba(220,235,255,1)" : "rgba(220,235,255,.55)";
    ctx.arc(x,y,Math.max(3,r*0.03),0,Math.PI*2);
    ctx.fill();
  }

  // centro
  const rCenter =
    cssW<=360 ? Math.max(26,r*.085) :
    cssW<=420 ? Math.max(30,r*.095) :
                Math.max(34,r*.105);
  const grad = ctx.createRadialGradient(cx,cy,rCenter*0.2,cx,cy,rCenter);
  grad.addColorStop(0,"#111827");
  grad.addColorStop(1,"#020617");
  ctx.beginPath();
  ctx.arc(cx,cy,rCenter,0,Math.PI*2);
  ctx.fillStyle = grad;
  ctx.fill();
  ctx.strokeStyle="rgba(124,77,255,.6)";
  ctx.lineWidth=Math.max(2,rCenter*.08);
  ctx.stroke();
}

/* loop de dibujo */
(function animateLoop(){
  drawWheel();
  requestAnimationFrame(animateLoop);
})();

/* ========= C√ÅLCULO GANADOR ========= */
function normAngle(rad){
  const T = Math.PI*2;
  return ((rad % T)+T)%T;
}
function winnerIndexByAngle(a){
  const n   = PRIZES.length;
  const arc = Math.PI*2/n;
  const pointer = Math.PI*1.5; // 12hs
  const rel = normAngle(pointer - a);
  return Math.floor(rel/arc)%n;
}
function animateTo(target,ms,cb){
  const startTime = performance.now();
  const from = angle;
  function loop(now){
    const k = Math.min(1, (now-startTime)/ms);
    const ease = 1 - Math.pow(1-k,3);
    angle = from + (target-from)*ease;
    if(k<1) requestAnimationFrame(loop); else if(cb) cb();
  }
  requestAnimationFrame(loop);
}

/* ========= PERSISTENCIA / COUNTDOWN ========= */
function restoreDaily(){
  const today = todayKey();
  const stored = localStorage.getItem("spin_date");
  if(stored && stored!==today){
    localStorage.removeItem("spin_done");
    localStorage.removeItem("spin_prize");
    localStorage.removeItem("spin_code");
    localStorage.removeItem("spin_ts");
  }
  localStorage.setItem("spin_date", today);
}
function restorePrizeIfAny(){
  const done  = localStorage.getItem("spin_done")==="1";
  const saved = localStorage.getItem("spin_prize");
  if(done && saved){
    const p = JSON.parse(saved);
    const code = localStorage.getItem("spin_code") || "‚Äî";
    const ts   = localStorage.getItem("spin_ts")   || tsString();
    badge.textContent = labelPrize(p);
    titleEl.textContent = "üéâ ¬°Premio obtenido!";
    subtitleEl.innerHTML = subtitleHTML(p);
    stampEl.textContent = "C√≥digo: "+code+" ¬∑ "+ts;
    claimBtn.disabled = false;
    spinBtn.disabled  = true;
    const msg = whatsappText(labelPrize(p));
    claimBtn.onclick = ()=>location.href=`https://wa.me/${WP}?text=${encodeURIComponent(msg)}`;
  }
}
function scheduleMidnightReset(){
  const now = new Date();
  const midnight = new Date(now.getFullYear(),now.getMonth(),now.getDate()+1,0,0,5,0);
  const ms = midnight.getTime()-now.getTime();
  setTimeout(()=>{
    localStorage.removeItem("spin_done");
    localStorage.removeItem("spin_prize");
    localStorage.removeItem("spin_code");
    localStorage.removeItem("spin_ts");
    localStorage.setItem("spin_date", todayKey());
    spinBtn.disabled=false;
    badge.textContent='-';
    titleEl.textContent='Ten√©s 1 giro disponible';
    subtitleEl.innerHTML='Los premios se acreditan con tu <b>pr√≥xima carga m√≠nima</b>.';
    stampEl.textContent='';
  }, ms);
}
function endOfDay(){
  const n=new Date();
  const end=new Date(n.getFullYear(),n.getMonth(),n.getDate(),23,59,0,0).getTime();
  return end > Date.now() ? end : new Date(n.getFullYear(),n.getMonth(),n.getDate()+1,23,59,0,0).getTime();
}
function tickCountdown(){
  const ms = endOfDay()-Date.now();
  const total = Math.max(0, Math.floor(ms/1000));
  const h = Math.floor(total/3600);
  const m = Math.floor((total%3600)/60);
  const s = total%60;
  countdownEl.textContent = h>0
    ? `${h}:${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`
    : `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
  if(ms<=0){
    promoBox.classList.add("expired");
    spinBtn.disabled=true;
    titleEl.textContent="‚è±Ô∏è Oferta finalizada";
    subtitleEl.innerHTML="Los giros promocionales se habilitan en la pr√≥xima ventana.";
  }
}

/* ========= CONFETTI ========= */
function confettiBurst(){
  confetti.innerHTML = "";
  const n = 28;
  for(let i=0;i<n;i++){
    const p = document.createElement("i");
    p.style.left = (Math.random()*100)+"vw";
    p.style.animationDelay = (Math.random()*0.5)+"s";
    p.style.background = Math.random()<0.5
      ? "linear-gradient(#80ffea,#4e9cff)"
      : "linear-gradient(#ffd166,#ff3d7f)";
    confetti.appendChild(p);
  }
  setTimeout(()=>{confetti.innerHTML="";},1800);
}

/* ========= SPIN ========= */
let stopTicks = null;
document.addEventListener("click",()=>AudioKit.unlock(),{once:true});

spinBtn.addEventListener("click", async ()=>{
  if(spinning) return;
  if(localStorage.getItem("spin_done")==="1"){
    alert("Ya usaste tu giro de hoy");
    return;
  }

  spinning = true;
  spinBtn.disabled = true;
  AudioKit.unlock();
  if(soundOn) stopTicks = AudioKit.spinStart();

  const extra  = 5 + Math.random()*1.5;
  const offset = Math.random()*Math.PI*2;
  const final  = angle + (Math.PI*2*extra) + offset;

  animateTo(final, 3000, async ()=>{
    angle = final;
    const idx   = winnerIndexByAngle(angle);
    const prize = PRIZES[idx];
    const prizeLabel = labelPrize(prize);

    // Otra chance: no cuenta como giro usado
    if(prize.type === "retry"){
      if(soundOn){
        if(stopTicks) stopTicks();
        AudioKit.win();
      }
      confettiBurst();
      badge.textContent = prizeLabel;
      titleEl.textContent = "üéÅ ¬°Otra chance!";
      subtitleEl.innerHTML = subtitleHTML(prize);
      stampEl.textContent = "";
      claimBtn.disabled = true;
      claimBtn.onclick = null;
      spinning=false;
      spinBtn.disabled=false;
      return;
    }

    // Premios reales
    const code = await makeClaimCode(prizeLabel);
    const ts   = tsString(new Date());
    localStorage.setItem("spin_code", code);
    localStorage.setItem("spin_ts", ts);

    badge.textContent = prizeLabel;
    titleEl.textContent = "üéâ ¬°Premio obtenido!";
    subtitleEl.innerHTML = subtitleHTML(prize);
    stampEl.textContent = "C√≥digo: "+code+" ¬∑ "+ts;

    const msg = whatsappText(prizeLabel);
    claimBtn.disabled = false;
    claimBtn.onclick = ()=>location.href=`https://wa.me/${WP}?text=${encodeURIComponent(msg)}`;

    localStorage.setItem("spin_done","1");
    localStorage.setItem("spin_prize", JSON.stringify(prize));
    localStorage.setItem("spin_date", todayKey());

    if(soundOn){
      if(stopTicks) stopTicks();
      AudioKit.win();
    }
    confettiBurst();
    spinning=false;
  });
});

/* ========= INIT ========= */
function init(){
  setSize();
  restoreDaily();
  restorePrizeIfAny();
  tickCountdown();
  setInterval(tickCountdown,1000);
  scheduleMidnightReset();
}
init();
</script>
</body>
</html>
